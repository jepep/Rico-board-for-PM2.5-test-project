#include <linux/init.h>' g" o3 ]& B* E7 R+ z
#include <linux/module.h>
#include <linux/device.h>
#include <linux/interrupt.h>2 [. P% f3 a, u/ d  X( Y+ T
#include <linux/interrupt.h>6 w# P9 K% I' X4 n; I( I
#include <linux/mtd/mtd.h>
#include <linux/mtd/partitions.h>& E' F, m1 L4 k! P' L
#include <linux/spi/spi.h>( @. @" D$ e& h1 n! l! u
#include <linux/of.h>
#include <linux/of_device.h>% _3 W: C3 M2 @
' `5 U( A7 k" t+ g
#define SSD1306_CMD    07 _8 n* w0 j6 n" U* f6 n
#define SSD1306_DAT    1" \8 i# K' @1 t" e. |% j6 A5 m4 W* t4 |
. A: ], y# F; {& f: J1 _
#define SSD1306_WIDTH    128& Z* E- x) i; y, V6 A$ }9 P2 S
#define SSD1306_HEIGHT   645 P& k/ H0 ^4 O3 ]/ c
9 w% w0 {! @. G" L; I
static uint8_t s_chDispalyBuffer[128][8];
* T3 w% X$ G7 g. @) a2 @3 l
const uint8_t c_chFont1608[95][16] = {      2 q% K7 A! U( ?7 }2 E
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*" ",0*/6 ^7 |( z0 L5 I3 p6 c, p0 Q/ a
{0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0xCC,0x00,0x0C,0x00,0x00,0x00,0x00,0x00,0x00},/*"!",1*/& F1 z8 {& d) D  v% u& _
{0x00,0x00,0x08,0x00,0x30,0x00,0x60,0x00,0x08,0x00,0x30,0x00,0x60,0x00,0x00,0x00},/*""",2*/$ J' N0 x( M7 J/ L4 X3 @" i
{0x02,0x20,0x03,0xFC,0x1E,0x20,0x02,0x20,0x03,0xFC,0x1E,0x20,0x02,0x20,0x00,0x00},/*"#",3*/& t# C* f0 B+ l
{0x00,0x00,0x0E,0x18,0x11,0x04,0x3F,0xFF,0x10,0x84,0x0C,0x78,0x00,0x00,0x00,0x00},/*"$",4*/) S: E9 b$ z+ C0 }
{0x0F,0x00,0x10,0x84,0x0F,0x38,0x00,0xC0,0x07,0x78,0x18,0x84,0x00,0x78,0x00,0x00},/*"%",5*/! D# f: [+ s0 ^4 R* ?% u
{0x00,0x78,0x0F,0x84,0x10,0xC4,0x11,0x24,0x0E,0x98,0x00,0xE4,0x00,0x84,0x00,0x08},/*"&",6*/5 u5 d! D3 P2 K9 d
{0x08,0x00,0x68,0x00,0x70,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"'",7*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xE0,0x18,0x18,0x20,0x04,0x40,0x02,0x00,0x00},/*"(",8*/
{0x00,0x00,0x40,0x02,0x20,0x04,0x18,0x18,0x07,0xE0,0x00,0x00,0x00,0x00,0x00,0x00},/*")",9*/" `/ I# x" {. H3 _% {1 H) [# f
{0x02,0x40,0x02,0x40,0x01,0x80,0x0F,0xF0,0x01,0x80,0x02,0x40,0x02,0x40,0x00,0x00},/*"*",10*/9 V8 u/ \, j5 x2 q. {' V1 E2 j& A
{0x00,0x80,0x00,0x80,0x00,0x80,0x0F,0xF8,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x00},/*"+",11*/7 T0 b( J1 V3 A( w5 |
{0x00,0x01,0x00,0x0D,0x00,0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*",",12*/
{0x00,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80},/*"-",13*/& R. s2 K0 {1 p# T' f
{0x00,0x00,0x00,0x0C,0x00,0x0C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*".",14*/0 E& O" w/ O- i  T) M) m
{0x00,0x00,0x00,0x06,0x00,0x18,0x00,0x60,0x01,0x80,0x06,0x00,0x18,0x00,0x20,0x00},/*"/",15*/$ _' d7 b  H  X
{0x00,0x00,0x07,0xF0,0x08,0x08,0x10,0x04,0x10,0x04,0x08,0x08,0x07,0xF0,0x00,0x00},/*"0",16*/
{0x00,0x00,0x08,0x04,0x08,0x04,0x1F,0xFC,0x00,0x04,0x00,0x04,0x00,0x00,0x00,0x00},/*"1",17*/
{0x00,0x00,0x0E,0x0C,0x10,0x14,0x10,0x24,0x10,0x44,0x11,0x84,0x0E,0x0C,0x00,0x00},/*"2",18*/
{0x00,0x00,0x0C,0x18,0x10,0x04,0x11,0x04,0x11,0x04,0x12,0x88,0x0C,0x70,0x00,0x00},/*"3",19*/4 v& P5 z# |. @8 d* t& O5 ^
{0x00,0x00,0x00,0xE0,0x03,0x20,0x04,0x24,0x08,0x24,0x1F,0xFC,0x00,0x24,0x00,0x00},/*"4",20*/: |7 z4 o: _0 e- ?
{0x00,0x00,0x1F,0x98,0x10,0x84,0x11,0x04,0x11,0x04,0x10,0x88,0x10,0x70,0x00,0x00},/*"5",21*/
{0x00,0x00,0x07,0xF0,0x08,0x88,0x11,0x04,0x11,0x04,0x18,0x88,0x00,0x70,0x00,0x00},/*"6",22*/
{0x00,0x00,0x1C,0x00,0x10,0x00,0x10,0xFC,0x13,0x00,0x1C,0x00,0x10,0x00,0x00,0x00},/*"7",23*/
{0x00,0x00,0x0E,0x38,0x11,0x44,0x10,0x84,0x10,0x84,0x11,0x44,0x0E,0x38,0x00,0x00},/*"8",24*/
{0x00,0x00,0x07,0x00,0x08,0x8C,0x10,0x44,0x10,0x44,0x08,0x88,0x07,0xF0,0x00,0x00},/*"9",25*/; x4 l* a& k4 m+ u5 |# w
{0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x0C,0x03,0x0C,0x00,0x00,0x00,0x00,0x00,0x00},/*":",26*/
{0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*";",27*/
{0x00,0x00,0x00,0x80,0x01,0x40,0x02,0x20,0x04,0x10,0x08,0x08,0x10,0x04,0x00,0x00},/*"<",28*/
{0x02,0x20,0x02,0x20,0x02,0x20,0x02,0x20,0x02,0x20,0x02,0x20,0x02,0x20,0x00,0x00},/*"=",29*/6 L: {, V4 M0 _( K
{0x00,0x00,0x10,0x04,0x08,0x08,0x04,0x10,0x02,0x20,0x01,0x40,0x00,0x80,0x00,0x00},/*">",30*/
{0x00,0x00,0x0E,0x00,0x12,0x00,0x10,0x0C,0x10,0x6C,0x10,0x80,0x0F,0x00,0x00,0x00},/*"?",31*/
{0x03,0xE0,0x0C,0x18,0x13,0xE4,0x14,0x24,0x17,0xC4,0x08,0x28,0x07,0xD0,0x00,0x00},/*"@",32*/
{0x00,0x04,0x00,0x3C,0x03,0xC4,0x1C,0x40,0x07,0x40,0x00,0xE4,0x00,0x1C,0x00,0x04},/*"A",33*/" B5 g: [* p9 D2 Q' ^1 D1 b
{0x10,0x04,0x1F,0xFC,0x11,0x04,0x11,0x04,0x11,0x04,0x0E,0x88,0x00,0x70,0x00,0x00},/*"B",34*/
{0x03,0xE0,0x0C,0x18,0x10,0x04,0x10,0x04,0x10,0x04,0x10,0x08,0x1C,0x10,0x00,0x00},/*"C",35*/: L% f. M$ t! T' b" K; l' x4 t
{0x10,0x04,0x1F,0xFC,0x10,0x04,0x10,0x04,0x10,0x04,0x08,0x08,0x07,0xF0,0x00,0x00},/*"D",36*/# t' Q& n1 i0 q5 R* m( _  t+ G
{0x10,0x04,0x1F,0xFC,0x11,0x04,0x11,0x04,0x17,0xC4,0x10,0x04,0x08,0x18,0x00,0x00},/*"E",37*/
{0x10,0x04,0x1F,0xFC,0x11,0x04,0x11,0x00,0x17,0xC0,0x10,0x00,0x08,0x00,0x00,0x00},/*"F",38*/2 M3 Z$ t+ c2 e( d' @2 Y' s% s
{0x03,0xE0,0x0C,0x18,0x10,0x04,0x10,0x04,0x10,0x44,0x1C,0x78,0x00,0x40,0x00,0x00},/*"G",39*/( z5 g9 P3 K% Y
{0x10,0x04,0x1F,0xFC,0x10,0x84,0x00,0x80,0x00,0x80,0x10,0x84,0x1F,0xFC,0x10,0x04},/*"H",40*/! ~" B, {  S  C( s) I" g+ B8 R
{0x00,0x00,0x10,0x04,0x10,0x04,0x1F,0xFC,0x10,0x04,0x10,0x04,0x00,0x00,0x00,0x00},/*"I",41*/
{0x00,0x03,0x00,0x01,0x10,0x01,0x10,0x01,0x1F,0xFE,0x10,0x00,0x10,0x00,0x00,0x00},/*"J",42*/
{0x10,0x04,0x1F,0xFC,0x11,0x04,0x03,0x80,0x14,0x64,0x18,0x1C,0x10,0x04,0x00,0x00},/*"K",43*/! }( y* T7 n. N$ v8 V8 b9 o9 x1 r
{0x10,0x04,0x1F,0xFC,0x10,0x04,0x00,0x04,0x00,0x04,0x00,0x04,0x00,0x0C,0x00,0x00},/*"L",44*/
{0x10,0x04,0x1F,0xFC,0x1F,0x00,0x00,0xFC,0x1F,0x00,0x1F,0xFC,0x10,0x04,0x00,0x00},/*"M",45*// ]2 Z: t% o$ S* g
{0x10,0x04,0x1F,0xFC,0x0C,0x04,0x03,0x00,0x00,0xE0,0x10,0x18,0x1F,0xFC,0x10,0x00},/*"N",46*/; k" }9 e( L& K) p1 S
{0x07,0xF0,0x08,0x08,0x10,0x04,0x10,0x04,0x10,0x04,0x08,0x08,0x07,0xF0,0x00,0x00},/*"O",47*/
{0x10,0x04,0x1F,0xFC,0x10,0x84,0x10,0x80,0x10,0x80,0x10,0x80,0x0F,0x00,0x00,0x00},/*"P",48*/
{0x07,0xF0,0x08,0x18,0x10,0x24,0x10,0x24,0x10,0x1C,0x08,0x0A,0x07,0xF2,0x00,0x00},/*"Q",49*/" V7 I) E  D3 o/ K; a
{0x10,0x04,0x1F,0xFC,0x11,0x04,0x11,0x00,0x11,0xC0,0x11,0x30,0x0E,0x0C,0x00,0x04},/*"R",50*/
{0x00,0x00,0x0E,0x1C,0x11,0x04,0x10,0x84,0x10,0x84,0x10,0x44,0x1C,0x38,0x00,0x00},/*"S",51*/
{0x18,0x00,0x10,0x00,0x10,0x04,0x1F,0xFC,0x10,0x04,0x10,0x00,0x18,0x00,0x00,0x00},/*"T",52*/" ?+ B) G+ X" Q
{0x10,0x00,0x1F,0xF8,0x10,0x04,0x00,0x04,0x00,0x04,0x10,0x04,0x1F,0xF8,0x10,0x00},/*"U",53*/
{0x10,0x00,0x1E,0x00,0x11,0xE0,0x00,0x1C,0x00,0x70,0x13,0x80,0x1C,0x00,0x10,0x00},/*"V",54*/+ v6 r& A3 F+ n5 Q
{0x1F,0xC0,0x10,0x3C,0x00,0xE0,0x1F,0x00,0x00,0xE0,0x10,0x3C,0x1F,0xC0,0x00,0x00},/*"W",55*/
{0x10,0x04,0x18,0x0C,0x16,0x34,0x01,0xC0,0x01,0xC0,0x16,0x34,0x18,0x0C,0x10,0x04},/*"X",56*/" U3 F; C& Z& D. \5 k; z
{0x10,0x00,0x1C,0x00,0x13,0x04,0x00,0xFC,0x13,0x04,0x1C,0x00,0x10,0x00,0x00,0x00},/*"Y",57*/
{0x08,0x04,0x10,0x1C,0x10,0x64,0x10,0x84,0x13,0x04,0x1C,0x04,0x10,0x18,0x00,0x00},/*"Z",58*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0xFE,0x40,0x02,0x40,0x02,0x40,0x02,0x00,0x00},/*"[",59*/
{0x00,0x00,0x30,0x00,0x0C,0x00,0x03,0x80,0x00,0x60,0x00,0x1C,0x00,0x03,0x00,0x00},/*"\",60*/3 N( x. |& y2 g( a
{0x00,0x00,0x40,0x02,0x40,0x02,0x40,0x02,0x7F,0xFE,0x00,0x00,0x00,0x00,0x00,0x00},/*"]",61*/' H/ K3 A$ b  j  H2 h
{0x00,0x00,0x00,0x00,0x20,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x20,0x00,0x00,0x00},/*"^",62*/
{0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01},/*"_",63*/+ _2 ^" Z: t: I& q% h8 H
{0x00,0x00,0x40,0x00,0x40,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"`",64*/) ^9 \* E5 f# d) |
{0x00,0x00,0x00,0x98,0x01,0x24,0x01,0x44,0x01,0x44,0x01,0x44,0x00,0xFC,0x00,0x04},/*"a",65*/
{0x10,0x00,0x1F,0xFC,0x00,0x88,0x01,0x04,0x01,0x04,0x00,0x88,0x00,0x70,0x00,0x00},/*"b",66*/- E1 j( g/ {5 p; y3 m  u5 b
{0x00,0x00,0x00,0x70,0x00,0x88,0x01,0x04,0x01,0x04,0x01,0x04,0x00,0x88,0x00,0x00},/*"c",67*/, m' u3 e8 o2 A; I/ b+ K1 `
{0x00,0x00,0x00,0x70,0x00,0x88,0x01,0x04,0x01,0x04,0x11,0x08,0x1F,0xFC,0x00,0x04},/*"d",68*/
{0x00,0x00,0x00,0xF8,0x01,0x44,0x01,0x44,0x01,0x44,0x01,0x44,0x00,0xC8,0x00,0x00},/*"e",69*/7 E5 I/ ~% H6 ]7 x! Y
{0x00,0x00,0x01,0x04,0x01,0x04,0x0F,0xFC,0x11,0x04,0x11,0x04,0x11,0x00,0x18,0x00},/*"f",70*/+ a4 I$ W. G' m" M- I' J: D% m- q
{0x00,0x00,0x00,0xD6,0x01,0x29,0x01,0x29,0x01,0x29,0x01,0xC9,0x01,0x06,0x00,0x00},/*"g",71*/
{0x10,0x04,0x1F,0xFC,0x00,0x84,0x01,0x00,0x01,0x00,0x01,0x04,0x00,0xFC,0x00,0x04},/*"h",72*/3 T& ^- Z, ]0 x6 k6 q
{0x00,0x00,0x01,0x04,0x19,0x04,0x19,0xFC,0x00,0x04,0x00,0x04,0x00,0x00,0x00,0x00},/*"i",73*/$ v7 K# ?5 J% |, M& k/ i
{0x00,0x00,0x00,0x03,0x00,0x01,0x01,0x01,0x19,0x01,0x19,0xFE,0x00,0x00,0x00,0x00},/*"j",74*/
{0x10,0x04,0x1F,0xFC,0x00,0x24,0x00,0x40,0x01,0xB4,0x01,0x0C,0x01,0x04,0x00,0x00},/*"k",75*/6 s# X" I( o. q0 U
{0x00,0x00,0x10,0x04,0x10,0x04,0x1F,0xFC,0x00,0x04,0x00,0x04,0x00,0x00,0x00,0x00},/*"l",76*/+ Z: T; Q0 ^2 f
{0x01,0x04,0x01,0xFC,0x01,0x04,0x01,0x00,0x01,0xFC,0x01,0x04,0x01,0x00,0x00,0xFC},/*"m",77*/* d7 T! q/ K2 d/ o% Z/ U
{0x01,0x04,0x01,0xFC,0x00,0x84,0x01,0x00,0x01,0x00,0x01,0x04,0x00,0xFC,0x00,0x04},/*"n",78*/8 |: ]9 r$ p8 M& c; [
{0x00,0x00,0x00,0xF8,0x01,0x04,0x01,0x04,0x01,0x04,0x01,0x04,0x00,0xF8,0x00,0x00},/*"o",79*/& T, ^4 f7 P, [1 A# `! l
{0x01,0x01,0x01,0xFF,0x00,0x85,0x01,0x04,0x01,0x04,0x00,0x88,0x00,0x70,0x00,0x00},/*"p",80*/
{0x00,0x00,0x00,0x70,0x00,0x88,0x01,0x04,0x01,0x04,0x01,0x05,0x01,0xFF,0x00,0x01},/*"q",81*/+ M5 k9 J4 g. y# z
{0x01,0x04,0x01,0x04,0x01,0xFC,0x00,0x84,0x01,0x04,0x01,0x00,0x01,0x80,0x00,0x00},/*"r",82*/
{0x00,0x00,0x00,0xCC,0x01,0x24,0x01,0x24,0x01,0x24,0x01,0x24,0x01,0x98,0x00,0x00},/*"s",83*/
{0x00,0x00,0x01,0x00,0x01,0x00,0x07,0xF8,0x01,0x04,0x01,0x04,0x00,0x00,0x00,0x00},/*"t",84*/
{0x01,0x00,0x01,0xF8,0x00,0x04,0x00,0x04,0x00,0x04,0x01,0x08,0x01,0xFC,0x00,0x04},/*"u",85*/
{0x01,0x00,0x01,0x80,0x01,0x70,0x00,0x0C,0x00,0x10,0x01,0x60,0x01,0x80,0x01,0x00},/*"v",86*/, X2 ^1 {/ v) a1 c: d
{0x01,0xF0,0x01,0x0C,0x00,0x30,0x01,0xC0,0x00,0x30,0x01,0x0C,0x01,0xF0,0x01,0x00},/*"w",87*/
{0x00,0x00,0x01,0x04,0x01,0x8C,0x00,0x74,0x01,0x70,0x01,0x8C,0x01,0x04,0x00,0x00},/*"x",88*/+ Z# s/ d* i! V% w
{0x01,0x01,0x01,0x81,0x01,0x71,0x00,0x0E,0x00,0x18,0x01,0x60,0x01,0x80,0x01,0x00},/*"y",89*/
{0x00,0x00,0x01,0x84,0x01,0x0C,0x01,0x34,0x01,0x44,0x01,0x84,0x01,0x0C,0x00,0x00},/*"z",90*/$ I5 W6 k9 h& R
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x3E,0xFC,0x40,0x02,0x40,0x02},/*"{",91*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00},/*"|",92*/
{0x00,0x00,0x40,0x02,0x40,0x02,0x3E,0xFC,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"}",93*/
{0x00,0x00,0x60,0x00,0x80,0x00,0x80,0x00,0x40,0x00,0x40,0x00,0x20,0x00,0x20,0x00},/*"~",94*/
};
2 P, P7 X  G5 I7 F! m. L' Z) [
struct spi_device *spi_ssd1306_dev;5 i" c# T6 |7 _: F5 F# y3 K

static void ssd1306_write_byte(uint8_t chData, uint8_t chCmd) 
{
    struct spi_transfer t;% n) t% Z8 j6 Z" A/ O
    struct spi_message m;& G6 Q5 x2 \1 b3 c

    uint16_t data = chData;! b. S2 C0 P. k9 w' p! t. \
    $ B, P. c& o* j8 q( ^9 k  P
    memset(&t,0,sizeof(struct spi_transfer));
     9 g. V/ X7 l) j
    if (chCmd) {' ?4 \  G/ Y' {1 m, p) g
        data |= (1 << 8);8 T# Z; D4 w3 r! ?# d* U( O
    } else {  o" n# P9 C/ v# N, ?0 a
        data &= ~(1 << 8);8 M; k& _& i# q. W' G% h
    }
# ^' C. s+ a! f2 P- D
    t.tx_buf = &data;' V+ @. q& Y  S" P( ?5 k' g
    t.len = 2;9 v6 L% R  A/ L
    t.bits_per_word = 9;
    //t.cs_change = 1;7 S9 {2 w$ Y% r: U- }( S( x. A: t
    spi_message_init(&m);
    spi_message_add_tail(&t, &m);  `5 m' u& J6 H6 H- u& j
    spi_sync(spi_ssd1306_dev, &m);
}


void ssd1306_display_on(void)
{
    ssd1306_write_byte(0x8D, SSD1306_CMD);  
    ssd1306_write_byte(0x14, SSD1306_CMD);  
    ssd1306_write_byte(0xAF, SSD1306_CMD);  8 r; M' z9 \6 s6 D! w6 l' _9 i
}
   
/**
  * @brief  OLED turns off
  *         
  * @param  None8 x* ~9 F, C* ^, w8 P
  *         
  * @retval  None
**/
void ssd1306_display_off(void)
{' d1 d4 H) q9 p- f
    ssd1306_write_byte(0x8D, SSD1306_CMD);  
    ssd1306_write_byte(0x10, SSD1306_CMD); " m) `& i6 ~7 T* g" h  w
    ssd1306_write_byte(0xAE, SSD1306_CMD);  
}- d8 |' w; c, p1 _8 [

void ssd1306_refresh_gram(void)
{
    uint8_t i, j;
    
    for (i = 0; i < 8; i ++) {  * p  g2 O( G7 p, r
        ssd1306_write_byte(0xB0 + i, SSD1306_CMD);    & I$ J- V  ?) _' [! X9 a% A' `
        ssd1306_write_byte(0x02, SSD1306_CMD); 
        ssd1306_write_byte(0x10, SSD1306_CMD);     + \" Z" i! b# f/ N8 C
        for (j = 0; j < 128; j ++) {
            ssd1306_write_byte(s_chDispalyBuffer[j][i], SSD1306_DAT); " u1 b7 Z8 x* A: {
        }
    }   
}- Y% X! W5 x1 L2 `9 O' O
2 K1 F& y' N( O) ~! E& }' m: c* L
# Z& M  i. Q; b7 c# i; o
void ssd1306_clear_screen(uint8_t chFill)  
{ 9 e+ f  j: m8 L6 n3 @6 q1 O: J
    memset(s_chDispalyBuffer,chFill, sizeof(s_chDispalyBuffer));
    ssd1306_refresh_gram();0 A2 [8 s# C& t, D9 ^! F/ O
}( u' C, Y/ V2 q5 E6 V

/**
  * @brief  Draws a piont on the screen" j# B* c) k* u
  *         * o; x# a% A- G' L1 J
  * @param  chXpos: Specifies the X position
  * @param  chYpos: Specifies the Y position7 j* \6 S  ]: i2 N3 o* @' g
  * @param  chPoint: 0: the point turns off    1: the piont turns on 
  *         : w' z# A6 I. e0 n7 u4 k
  * @retval None* H2 O" W6 U' ?" i  z0 }
**/
7 s& t2 P+ T+ P' m6 r
void ssd1306_draw_point(uint8_t chXpos, uint8_t chYpos, uint8_t chPoint), h% }# e% L  k( w1 N3 O" ~
{- n" V# ?2 Z$ q2 U; ?
    uint8_t chPos, chBx, chTemp = 0;& s# o! L$ {! W' k/ M
    $ n; n# L9 o- D( S1 T
    if (chXpos > 127 || chYpos > 63) {
        return;  T7 f; O: a+ c" [6 d- ~- v0 ~% h
    }9 j+ B  m% D% q
    chPos = 7 - chYpos / 8; // + A" C, A0 G& W
    chBx = chYpos % 8;
    chTemp = 1 << (7 - chBx);  o. V0 |+ Q" `+ g5 k
    
    if (chPoint) {) H# G6 k6 k' p* J
        s_chDispalyBuffer[chXpos][chPos] |= chTemp;2 ]# i/ Q9 v. |% y5 s2 E
        + r' `* \- x0 _. H- r% @7 n
    } else {5 m2 F* U" b9 W/ M
        s_chDispalyBuffer[chXpos][chPos] &= ~chTemp;- x) L% z" W( U' |
    }
}1 q7 W1 J6 q+ L# V1 n3 H, I' [
      
/**0 g% d* g5 [8 x$ i) U- F
  * @brief  Fills a rectangle
  *         
  * @param  chXpos1: Specifies the X position 1 (X top left position)
  * @param  chYpos1: Specifies the Y position 1 (Y top left position)
  * @param  chXpos2: Specifies the X position 2 (X bottom right position)- t: c; N% Z: ?; O$ A) J8 J! O
  * @param  chYpos3: Specifies the Y position 2 (Y bottom right position)# B) R: }; }/ a9 }5 R1 _7 g
  *         
  * @retval ! v; S! T' F$ _' e, C8 C" A
**/% ?% ^& Z  ~* |' t9 u( O& v! @& S; j

void ssd1306_fill_screen(uint8_t chXpos1, uint8_t chYpos1, uint8_t chXpos2, uint8_t chYpos2, uint8_t chDot)  $ u4 u& _8 i( @- Y8 [
{  1 m1 ?! w& t9 C
    uint8_t chXpos, chYpos; 4 ]- K% n, a* L$ Y2 G
    + z5 U( d6 G: `4 ~! d
    for (chXpos = chXpos1; chXpos <= chXpos2; chXpos ++) {. D& t; ~! t5 `% [# p6 `% k
        for (chYpos = chYpos1; chYpos <= chYpos2; chYpos ++) {
            ssd1306_draw_point(chXpos, chYpos, chDot);+ R, q. m& E4 Y- k, y
        }
    }    : ?7 U0 c7 p: B9 C* |& U# Q
    ! J1 n; b; B" r1 Z: v
    ssd1306_refresh_gram();, ~7 r  R4 x. t6 l( V
}

* K8 L: \1 w* k; n
/**
  * @brief Displays one character at the specified position    ) d2 t5 I5 u( n1 t; L2 G
  *         " H+ [. N- \6 S
  * @param  chXpos: Specifies the X position
  * @param  chYpos: Specifies the Y position
  * @param  chSize: 
  * @param  chMode
  * @retval " i% F, i& X" @! Y  o: y! Z
**/9 j& m( `4 K* L. {5 E
void ssd1306_display_char(uint8_t chXpos, uint8_t chYpos, uint8_t chChr, uint8_t chSize, uint8_t chMode)
{          $ Y; k; }& _$ W/ D3 W1 @8 K4 m
    uint8_t i, j;5 j7 a5 t# y0 H+ \* v. X: f
    uint8_t chTemp, chYpos0 = chYpos;
    
    chChr = chChr - ' ';                     \/ }( G9 Z6 S& l( v
    for (i = 0; i < chSize; i ++) {   # b  v" d5 a) }/ A1 W
        if (chMode) {7 M" ~/ x' z6 Q1 J9 ^  P; `9 i
            chTemp = c_chFont1608[chChr][i];
        } else {# v( [. g0 e; M
            chTemp = ~c_chFont1608[chChr][i];
        }2 Z+ w3 x/ j* ?5 I- u  Y- \* e$ ?, i
        " P# N9 ]) [: |
        for (j = 0; j < 8; j ++) {
            if (chTemp & 0x80) {
                ssd1306_draw_point(chXpos, chYpos, 1);( ?; U7 L, @& w4 L
            } else {
                ssd1306_draw_point(chXpos, chYpos, 0);
            }; M) a- b- t6 C) \  r' M4 o$ C
            chTemp <<= 1;. Y: K/ o8 O5 O8 d1 v
            chYpos ++;) s: e/ j6 x4 ^& b' E
            
            if ((chYpos - chYpos0) == chSize) {
                chYpos = chYpos0;* ^! a: m. @/ {* m& V4 O
                chXpos ++;3 m& i/ f3 ~# }2 x  X( R  v
                break;
            }9 V3 Z2 Q2 s9 T: ]
        }       
    } 
}    

/**
  * @brief  Displays a string on the screen
  *         " C- e+ y5 C! t8 ~4 J4 p
  * @param  chXpos: Specifies the X position
  * @param  chYpos: Specifies the Y position
  * @param  pchString: Pointer to a string to display on the screen $ T4 u8 t5 x' ^- I6 v" s9 G0 X) b5 u2 V
  *         
  * @retval  None: f) d2 r% y3 k. l/ D  ^
**/
void ssd1306_display_string(uint8_t chXpos, uint8_t chYpos, const uint8_t *pchString, uint8_t chSize, uint8_t chMode)
{
    while (*pchString != '\0') {       
        if (chXpos > (SSD1306_WIDTH - chSize / 2)) {
            chXpos = 0;! S( N  M# k3 [& i
            chYpos += chSize;
            if (chYpos > (SSD1306_HEIGHT - chSize)) {4 N: a" }0 w8 E$ t; \, K
                chYpos = chXpos = 0;
                ssd1306_clear_screen(0x00);7 H% l7 t. u  c
            }
        }+ x' O9 D/ r- D& B6 j3 @% P% H
        
        ssd1306_display_char(chXpos, chYpos, *pchString, chSize, chMode);1 c- \: y! I6 o( X: k5 V
        chXpos += chSize / 2;
        pchString ++;
    }
}

void ssd1306_init(void)1 K& @" N9 t6 ]& n* k5 z1 ]2 c* S# n
{
#if 1. a0 U- B$ P8 f; s* A) ?- \
    ssd1306_write_byte(0xAE, SSD1306_CMD);//--turn off oled panel" \. w4 C% A/ u+ f2 i
    ssd1306_write_byte(0x00, SSD1306_CMD);//---set low column address  ], G* }: ~$ D* @& U* e
    ssd1306_write_byte(0x10, SSD1306_CMD);//---set high column address
    ssd1306_write_byte(0x40, SSD1306_CMD);//--set start line address  Set Mapping RAM Display Start Line (0x00~0x3F)8 k5 D4 j! |# l, e$ d  D7 a
    ssd1306_write_byte(0x81, SSD1306_CMD);//--set contrast control register
    ssd1306_write_byte(0xCF, SSD1306_CMD);// Set SEG Output Current Brightness5 T% K0 r- Y- G$ N" e
    ssd1306_write_byte(0xA1, SSD1306_CMD);//--Set SEG/Column Mapping     
    ssd1306_write_byte(0xC0, SSD1306_CMD);//Set COM/Row Scan Direction   ( Z  K: A- I2 k5 y2 B8 n
    ssd1306_write_byte(0xA6, SSD1306_CMD);//--set normal display
    ssd1306_write_byte(0xA8, SSD1306_CMD);//--set multiplex ratio(1 to 64)5 `( d  C' i% |7 }! A
    ssd1306_write_byte(0x3f, SSD1306_CMD);//--1/64 duty
    ssd1306_write_byte(0xD3, SSD1306_CMD);//-set display offset    Shift Mapping RAM Counter (0x00~0x3F); `! T$ E6 D% g/ B
    ssd1306_write_byte(0x00, SSD1306_CMD);//-not offset. H6 b! I& C; {
    ssd1306_write_byte(0xd5, SSD1306_CMD);//--set display clock divide ratio/oscillator frequency2 X* Q  U7 Y7 y3 d; ~5 m" N
    ssd1306_write_byte(0x80, SSD1306_CMD);//--set divide ratio, Set Clock as 100 Frames/Sec
    ssd1306_write_byte(0xD9, SSD1306_CMD);//--set pre-charge period8 ~8 I' Q# B) t) {7 V3 z2 y
    ssd1306_write_byte(0xF1, SSD1306_CMD);//Set Pre-Charge as 15 Clocks & Discharge as 1 Clock7 G3 f, q0 ]1 H: T( V2 D- T0 n
    ssd1306_write_byte(0xDA, SSD1306_CMD);//--set com pins hardware configuration% x* R5 b4 g5 |, }' o
    ssd1306_write_byte(0x12, SSD1306_CMD);- E" l8 ]! l' e; G4 ^/ @: w7 g
    ssd1306_write_byte(0xDB, SSD1306_CMD);//--set vcomh
    ssd1306_write_byte(0x40, SSD1306_CMD);//Set VCOM Deselect Level
    ssd1306_write_byte(0x20, SSD1306_CMD);//-Set Page Addressing Mode (0x00/0x01/0x02)
    ssd1306_write_byte(0x02, SSD1306_CMD);//
    ssd1306_write_byte(0x8D, SSD1306_CMD);//--set Charge Pump enable/disable
    ssd1306_write_byte(0x14, SSD1306_CMD);//--set(0x10) disable
    ssd1306_write_byte(0xA4, SSD1306_CMD);// Disable Entire Display On (0xa4/0xa5)
    ssd1306_write_byte(0xA6, SSD1306_CMD);// Disable Inverse Display On (0xa6/a7) 
    ssd1306_write_byte(0xAF, SSD1306_CMD);//--turn on oled panel" d2 [$ q- G& D# Y' U% E
#else
           ssd1306_write_byte(0xAE, SSD1306_CMD);//--turn off oled panel, M8 E, e: }- J2 l  r: Q$ b. s
    ssd1306_write_byte(0x00, SSD1306_CMD);//---set low column address
    ssd1306_write_byte(0x10, SSD1306_CMD);//---set high column address1 I' G. \. S) n* {$ u6 m6 _; o7 R, B  y
    ssd1306_write_byte(0x40, SSD1306_CMD);//--set start line address  Set Mapping RAM Display Start Line (0x00~0x3F)
    ssd1306_write_byte(0xB0, SSD1306_CMD);//    ssd1306_write_byte(0xC0, SSD1306_CMD);//Set COM/Row Scan Direction   0 ~7 f" ?, Y& N$ ~, N2 z
( f& z6 Z! X$ Z0 l5 x* I" s+ l
    ssd1306_write_byte(0x81, SSD1306_CMD);//--set contrast control register1 \. L0 z' K' O4 @) P5 U. q
    ssd1306_write_byte(0xCF, SSD1306_CMD);// Set SEG Output Current Brightness
    ssd1306_write_byte(0xA1, SSD1306_CMD);//--Set SEG/Column Mapping     + j9 A$ J# X; A
    ssd1306_write_byte(0xA6, SSD1306_CMD);//--set normal display* [7 |( ]) K" k. U5 Q" a
    ssd1306_write_byte(0xA8, SSD1306_CMD);//--set multiplex ratio(1 to 64)3 v' f6 W' ~% u8 `# p0 k
    ssd1306_write_byte(0x3f, SSD1306_CMD);//--1/64 duty4 h6 y8 U/ j  }0 s! ?- Y1 N
    ssd1306_write_byte(0xC8, SSD1306_CMD);//-set display offset    Shift Mapping RAM Counter (0x00~0x3F)1 i$ a- N/ t* j) _% u9 h
    ssd1306_write_byte(0xD3, SSD1306_CMD);//-set display offset    Shift Mapping RAM Counter (0x00~0x3F)2 m: \3 V2 k9 E
    ssd1306_write_byte(0xC0, SSD1306_CMD);//-not offset/ w) h# |: ^6 f) {. z" L
    ssd1306_write_byte(0xd5, SSD1306_CMD);//--set display clock divide ratio/oscillator frequency( r+ D  F! ?, R! _$ r% o; ~: c
    ssd1306_write_byte(0x80, SSD1306_CMD);//--set divide ratio, Set Clock as 100 Frames/Sec
    ssd1306_write_byte(0xD9, SSD1306_CMD);//--set pre-charge period% H1 z! |1 B9 d% l& I
    ssd1306_write_byte(0xF1, SSD1306_CMD);//Set Pre-Charge as 15 Clocks & Discharge as 1 Clock
    ssd1306_write_byte(0xDA, SSD1306_CMD);//--set com pins hardware configuration
    ssd1306_write_byte(0x12, SSD1306_CMD);
    ssd1306_write_byte(0xDB, SSD1306_CMD);//--set vcomh
    ssd1306_write_byte(0x40, SSD1306_CMD);//Set VCOM Deselect Level

    ssd1306_write_byte(0x8D, SSD1306_CMD);//--set Charge Pump enable/disable4 z  o" C5 _% T2 C& q" D
    ssd1306_write_byte(0x10, SSD1306_CMD);//--set(0x10) disable! N( R& @: f* h( q0 V7 h# a# ^

    ssd1306_write_byte(0xAF, SSD1306_CMD);//--turn on oled panel. B6 [0 ]1 F, \/ t
" h$ B2 F. h* _7 L! W; Q) K/ _
#endif
    ssd1306_display_on();9 q0 V9 `9 d; O9 F) b
    ssd1306_clear_screen(0xff);
    , j2 n0 P% k% R3 I# d( p
}- d6 J; @4 X1 \7 @- E  u

/ [' m0 J* f2 Y) @1 V
static int spi_ssd1306_probe(struct spi_device *spi)9 ?8 l; x& p, j
{
        printk("=11=spi_ssd1306_probe\n");
        spi_ssd1306_dev = spi;3 A- M6 F: G; ?& T6 E# N
        spi_ssd1306_dev->bits_per_word = 9;! W0 `3 N, c$ x* f5 z7 {% z
        7 Z- t' q. \# b5 Z2 z8 U" A
        ssd1306_init();7 [" Q1 Z# l5 N+ l! @  m& Z
        printk("=2=spi_ssd1306_probe\n");& G- k. @) p3 r- V9 g
        ssd1306_clear_screen(0x00);( J7 R* k' m6 @/ _6 w6 Q
        printk("=3=spi_ssd1306_probe\n");
        ssd1306_display_off();
        printk("=4=spi_ssd1306_probe\n");
        8 T* h% v0 k4 L/ x* Z
        ssd1306_display_string(18, 0, "hello, Linux!", 16, 1);
        ssd1306_display_string(0, 16, "this is a spi driver demo!", 16, 1);
        ssd1306_refresh_gram();2 i0 R. O# }7 O; u; r" q: X
        ssd1306_display_on();
        printk("=5=spi_ssd1306_probe\n");, R3 U' d$ q; {  h- ^4 r
        
        return 0;- S% E# @0 ?2 s4 c) _
}


static int spi_ssd1306_remove(struct spi_device *spi)9 i9 ^+ k+ E" J$ Y( x
{
    printk("ssd1306_remove\n");
    1 y6 K  i1 E* `, n" d2 \% i
    ssd1306_clear_screen(0x00);+ W) F6 \7 A9 M8 c+ E; O
    ssd1306_display_off();- e( O9 d& \0 K- d( M
    return 0;
}

static const struct of_device_id ssd1306_dt_ids[] = {
        { .compatible = "oled,ssd1306" },+ A% x& a- b9 _  @! j$ m$ ?
        {},' k, f1 z; h4 j
};
MODULE_DEVICE_TABLE(of, ssd1306_dt_ids);
static struct spi_driver spi_ssd1306_driver = {
    .driver = {
        .name    = "spi_ssd1306",
        .bus    = &spi_bus_type,
        .owner    = THIS_MODULE,
                                .of_match_table = of_match_ptr(ssd1306_dt_ids),
    },! \: V, \' w8 L' g4 C0 C& J
    .probe    = spi_ssd1306_probe,' t3 P5 P' z6 E! i. G; F
    .remove    = spi_ssd1306_remove,
};
: J  l" [/ {* s8 p
7 d1 \" c: v, C- A" F
static int __init spi_ssd1306_init(void)) }( Y. L& O/ s& M/ j
{- C( R  y+ q& n* W( a
        printk("=0000=spi_ssd1306_init\n");
    return spi_register_driver(&spi_ssd1306_driver);
}) A" A# {3 S4 l/ Q


static void __exit spi_ssd1306_exit(void)
{
    spi_unregister_driver(&spi_ssd1306_driver);1 j) t* {- C* @: m- m# D
}+ @- B* O% Z: w


module_init(spi_ssd1306_init);
module_exit(spi_ssd1306_exit);' b9 g" F$ i) i
+ m' \4 j/ H* G0 U0 J
MODULE_LICENSE("GPL");
